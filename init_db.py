import os
import json
from datetime import datetime
from pymongo import MongoClient
from pymongo.errors import ConnectionFailure, OperationFailure
from dotenv import load_dotenv

# Load environment variables from .env file
load_dotenv()

# Configuration pour MongoDB local
MONGO_URI = os.getenv("MONGO_URI")
MONGO_DB_NAME = os.getenv("MONGO_DB_NAME", "geeks_institute_db")

# Define the path to your sessions.json file relative to this script
SESSIONS_DATA_PATH = os.path.join(os.path.dirname(__file__), 'data', 'sessions.json')

print(f"üîß Configuration MongoDB:")
print(f"   URI: {MONGO_URI}")
print(f"   Database: {MONGO_DB_NAME}")
print("-" * 50)

def init_db():
    """
    Initializes the local MongoDB database.
    Drops existing 'students', 'conversations', 'sessions', and 'liste_numeros' collections for a clean slate,
    then inserts sample bootcamp session data and authorized phone numbers.
    Ensures indexes on relevant collections.
    """
    client = None
    try:
        # Configuration pour MongoDB local
        client = MongoClient(
            MONGO_URI,
            serverSelectionTimeoutMS=5000,  # 5 secondes timeout
            connectTimeoutMS=10000,         # 10 secondes pour la connexion
            socketTimeoutMS=10000           # 10 secondes pour les sockets
        )
        
        # Test de connexion
        client.admin.command('ping')
        db = client[MONGO_DB_NAME]

        print(f"‚úÖ Connected to local MongoDB database: {MONGO_DB_NAME}")
        print(f"üìç Server info: {client.server_info()['version']}")

        # Drop existing collections for a clean setup (useful during development)
        print("\nüóëÔ∏è  Dropping existing collections...")
        collections_to_drop = ['students', 'conversations', 'sessions', 'liste_numeros']
        
        existing_collections = db.list_collection_names()
        print(f"üìã Existing collections: {existing_collections}")
        
        for collection_name in collections_to_drop:
            if collection_name in existing_collections:
                db[collection_name].drop()
                print(f"   ‚úÖ Collection '{collection_name}' dropped.")
            else:
                print(f"   ‚ÑπÔ∏è  Collection '{collection_name}' doesn't exist, skipping.")

        # Create collections explicitly
        print("\nüìÅ Creating collections...")
        db.create_collection('students')
        db.create_collection('sessions')
        db.create_collection('liste_numeros')
        print("   ‚úÖ Collections 'students', 'sessions', and 'liste_numeros' created.")

        # Ensure indexes for performance and data integrity
        print("\nüîç Creating indexes...")
        db.students.create_index("whatsapp_id", unique=True)
        print("   ‚úÖ Unique index on students.whatsapp_id")
        
        db.sessions.create_index([("program_name", 1), ("location", 1)])
        print("   ‚úÖ Compound index on sessions (program_name, location)")
        
        db.liste_numeros.create_index("numero", unique=True)
        print("   ‚úÖ Unique index on liste_numeros.numero")
        
        db.liste_numeros.create_index("actif")
        print("   ‚úÖ Index on liste_numeros.actif")

        # Sample bootcamp sessions data
        print("\nüìö Inserting sample sessions...")
        sessions_data = [
            {
                "program_name": "D√©veloppement Web (Full-Stack)",
                "location": "Casablanca",
                "start_date": "2025-09-01T09:00:00Z",
                "duration_months": 8,
                "price": 45000,
                "available_spots": 20,
                "requirements": ["Logique de base en programmation", "Motivation"],
                "description": "Apprenez √† construire des applications web compl√®tes, du frontend au backend, avec les technologies les plus demand√©es.",
                "created_at": datetime.now(),
                "updated_at": datetime.now()
            },
            {
                "program_name": "D√©veloppement Mobile",
                "location": "Rabat",
                "start_date": "2025-10-15T09:00:00Z",
                "duration_months": 8,
                "price": 48000,
                "available_spots": 18,
                "requirements": ["Connaissances en programmation orient√©e objet", "Cr√©ativit√©"],
                "description": "Ma√Ætrisez le d√©veloppement d'applications natives iOS et Android, ainsi que les frameworks hybrides populaires.",
                "created_at": datetime.now(),
                "updated_at": datetime.now()
            },
            {
                "program_name": "Data Science & Intelligence Artificielle",
                "location": "Casablanca",
                "start_date": "2025-11-01T09:00:00Z",
                "duration_months": 10,
                "price": 52000,
                "available_spots": 15,
                "requirements": ["Math√©matiques de base", "Logique de programmation"],
                "description": "Ma√Ætrisez l'analyse de donn√©es, le machine learning et l'IA avec Python et les outils modernes.",
                "created_at": datetime.now(),
                "updated_at": datetime.now()
            }
        ]

        # Sample authorized phone numbers data
        print("üì± Inserting authorized phone numbers...")
        numeros_autorises_data = [
            {
                "numero": "+212643370003",
                "nom": "Mohamed Meksi",
                "description": "√âtudiant potentiel - Programme Web Development",
                "date_ajout": datetime.now(),
                "actif": True,
                "type_utilisateur": "etudiant",
                "notes": "Contact initial via site web"
            },
            {
                "numero": "+212700000002", 
                "nom": "Fatima Zahra",
                "description": "√âtudiante potentielle - Programme Mobile",
                "date_ajout": datetime.now(),
                "actif": True,  # Chang√© √† True pour les tests
                "type_utilisateur": "etudiant",
                "notes": "Recommand√©e par un ancien √©tudiant"
            },
            {
                "numero": "+212600000001",
                "nom": "Ahmed Benali",
                "description": "Administrateur syst√®me",
                "date_ajout": datetime.now(),
                "actif": True,
                "type_utilisateur": "admin",
                "notes": "Acc√®s administrateur complet"
            },
            {
                "numero": "+212500000005",
                "nom": "Khadija Alami",
                "description": "Conseill√®re p√©dagogique",
                "date_ajout": datetime.now(),
                "actif": True,
                "type_utilisateur": "staff",
                "notes": "Support p√©dagogique et orientation"
            }
        ]

        # Insert sample sessions
        if sessions_data:
            result = db.sessions.insert_many(sessions_data)
            print(f"   ‚úÖ {len(result.inserted_ids)} sessions inserted successfully")
        else:
            print("   ‚ö†Ô∏è  No sample sessions to insert")

        # Insert authorized phone numbers
        if numeros_autorises_data:
            result = db.liste_numeros.insert_many(numeros_autorises_data)
            print(f"   ‚úÖ {len(result.inserted_ids)} authorized numbers inserted successfully")
            
            # Display the authorized numbers for reference
            print(f"\nüì± Num√©ros autoris√©s ajout√©s:")
            print("=" * 70)
            for numero in numeros_autorises_data:
                status = "‚úÖ Actif" if numero['actif'] else "‚ùå Inactif"
                print(f"  {numero['numero']} - {numero['nom']}")
                print(f"     Type: {numero['type_utilisateur']} | Status: {status}")
                print(f"     Description: {numero['description']}")
                print("-" * 50)
        else:
            print("   ‚ö†Ô∏è  No authorized phone numbers to insert")

        # Statistics
        print(f"\nüìä Database Statistics:")
        print(f"   üìö Sessions: {db.sessions.count_documents({})}")
        print(f"   üë§ Students: {db.students.count_documents({})}")
        print(f"   üì± Authorized numbers: {db.liste_numeros.count_documents({})}")
        print(f"   üì± Active numbers: {db.liste_numeros.count_documents({'actif': True})}")

        print(f"\nüéâ Local MongoDB initialization complete!")
        print(f"üè† Database: {MONGO_DB_NAME}")
        print(f"üîó Connection: {MONGO_URI}")

    except ConnectionFailure as e:
        print(f"‚ùå ERROR: MongoDB connection failed.")
        print(f"   Please ensure MongoDB is running locally on port 27017")
        print(f"   You can start MongoDB with: mongod --dbpath /your/db/path")
        print(f"   Details: {e}")
    except OperationFailure as e:
        print(f"‚ùå ERROR: MongoDB operation failed during initialization.")
        print(f"   Details: {e}")
    except FileNotFoundError:
        print(f"‚ö†Ô∏è  WARNING: sessions.json not found at {SESSIONS_DATA_PATH}")
        print(f"   Using hardcoded sample data instead")
    except json.JSONDecodeError as e:
        print(f"‚ùå ERROR: Failed to decode sessions.json")
        print(f"   Please check the JSON file format. Details: {e}")
    except Exception as e:
        print(f"‚ùå UNEXPECTED ERROR occurred during MongoDB initialization: {e}")
        import traceback
        traceback.print_exc()
    finally:
        if client:
            client.close()
            print("\nüîê MongoDB connection closed.")

def add_phone_number(numero, nom, description="", type_utilisateur="etudiant", notes=""):
    """
    Fonction utilitaire pour ajouter un nouveau num√©ro autoris√© √† la base locale
    
    Args:
        numero (str): Num√©ro de t√©l√©phone au format international (+212...)
        nom (str): Nom de la personne
        description (str): Description optionnelle
        type_utilisateur (str): Type (etudiant, admin, partenaire, alumni, staff)
        notes (str): Notes additionnelles
    """
    client = None
    try:
        client = MongoClient(MONGO_URI, serverSelectionTimeoutMS=5000)
        db = client[MONGO_DB_NAME]
        
        # V√©rifier si le num√©ro existe d√©j√†
        existing = db.liste_numeros.find_one({"numero": numero})
        if existing:
            print(f"‚ö†Ô∏è  Le num√©ro {numero} existe d√©j√† dans la base de donn√©es.")
            print(f"   Utilisateur existant: {existing.get('nom', 'N/A')}")
            return False
        
        # Ajouter le nouveau num√©ro
        nouveau_numero = {
            "numero": numero,
            "nom": nom,
            "description": description,
            "date_ajout": datetime.now(),
            "actif": True,
            "type_utilisateur": type_utilisateur,
            "notes": notes
        }
        
        result = db.liste_numeros.insert_one(nouveau_numero)
        print(f"‚úÖ Num√©ro {numero} ajout√© avec succ√®s")
        print(f"   Nom: {nom}")
        print(f"   Type: {type_utilisateur}")
        print(f"   ID: {result.inserted_id}")
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur lors de l'ajout du num√©ro {numero}: {e}")
        return False
    finally:
        if client:
            client.close()

def list_authorized_numbers():
    """
    Liste tous les num√©ros autoris√©s dans la base locale
    """
    client = None
    try:
        client = MongoClient(MONGO_URI, serverSelectionTimeoutMS=5000)
        db = client[MONGO_DB_NAME]
        
        numbers = list(db.liste_numeros.find({}).sort("date_ajout", -1))
        
        if not numbers:
            print("üì± Aucun num√©ro autoris√© trouv√© dans la base de donn√©es.")
            return
        
        print(f"\nüì± Liste des num√©ros autoris√©s ({len(numbers)} total):")
        print("=" * 80)
        
        for numero in numbers:
            status = "‚úÖ Actif" if numero.get('actif', False) else "‚ùå Inactif"
            print(f"üìû {numero['numero']} - {numero.get('nom', 'N/A')}")
            print(f"   Type: {numero.get('type_utilisateur', 'N/A')} | Status: {status}")
            print(f"   Description: {numero.get('description', 'N/A')}")
            print(f"   Ajout√©: {numero.get('date_ajout', 'N/A')}")
            if numero.get('notes'):
                print(f"   Notes: {numero['notes']}")
            print("-" * 60)
            
    except Exception as e:
        print(f"‚ùå Erreur lors de la r√©cup√©ration des num√©ros: {e}")
    finally:
        if client:
            client.close()

def test_connection():
    """
    Test la connexion √† la base de donn√©es locale
    """
    client = None
    try:
        print("üîç Test de connexion √† MongoDB local...")
        client = MongoClient(MONGO_URI, serverSelectionTimeoutMS=5000)
        
        # Test ping
        client.admin.command('ping')
        print("‚úÖ Ping successful")
        
        # Test database access
        db = client[MONGO_DB_NAME]
        collections = db.list_collection_names()
        print(f"‚úÖ Database accessible: {MONGO_DB_NAME}")
        print(f"   Collections: {collections}")
        
        # Test collections count
        for collection_name in ['students', 'sessions', 'liste_numeros']:
            if collection_name in collections:
                count = db[collection_name].count_documents({})
                print(f"   {collection_name}: {count} documents")
        
        print("üéâ Connection test successful!")
        return True
        
    except Exception as e:
        print(f"‚ùå Connection test failed: {e}")
        print("   Make sure MongoDB is running locally on port 27017")
        return False
    finally:
        if client:
            client.close()

if __name__ == "__main__":
    import sys
    
    if len(sys.argv) > 1:
        command = sys.argv[1]
        
        if command == "add_number":
            # Usage: python init_db.py add_number "+212600000007" "Nom Pr√©nom" "Description"
            if len(sys.argv) >= 4:
                numero = sys.argv[2]
                nom = sys.argv[3]
                description = sys.argv[4] if len(sys.argv) > 4 else ""
                type_user = sys.argv[5] if len(sys.argv) > 5 else "etudiant"
                add_phone_number(numero, nom, description, type_user)
            else:
                print("Usage: python init_db.py add_number <numero> <nom> [description] [type_utilisateur]")
                
        elif command == "list_numbers":
            list_authorized_numbers()
            
        elif command == "test":
            test_connection()
            
        else:
            print("Commands available:")
            print("  init_db.py                    - Initialize database")
            print("  init_db.py add_number         - Add authorized number")
            print("  init_db.py list_numbers       - List all authorized numbers")
            print("  init_db.py test              - Test database connection")
    else:
        init_db()